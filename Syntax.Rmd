---
title: "Bayes Fix"
author: "Indra Mahib"
date: "`r Sys.Date()`"
output: word_document
---

```{r}
library(TSA)
library(forecast)
library(ggplot2)
library(dplyr)
library(tseries)
library(lmtest) ## granger
library(urca) ## jo.ca
library(vars) ## VAR dan VARselect
library(readxl)
library(BVAR)
library(tidyr)

## fun
mape <- function(y,yhat){
  mean(abs((y - yhat) / y) * 100)
}
```

# Data
```{r}
dt <- read_excel("D:\\IPB\\6\\Bayes\\Projek\\data4.xlsx",sheet="data")

# preprocessing
names(dt) <- tolower(names(dt))
names(dt)[5] <- "exc.rate"
names(dt)[7] <- "emas"

dt$periode <- paste0("01-", sprintf("%02d", dt$bulan), "-", dt$tahun)
dt$periode <- as.Date(dt$periode, format = "%d-%m-%Y")
```


```{r}
head(dt)
```
## Pilih Peubah
```{r}
dt1 <- dt %>% dplyr::select(periode,ekspor,impor,exc.rate,emas,inflasi)

#remove comma in ekspor,import, and exc.rate
# dt1$ekspor <- as.numeric(gsub(",", "", dt1$ekspor))
# dt1$impor <- as.numeric(gsub(",", "", dt1$impor))
# dt1$exc.rate <- as.numeric(gsub(",", "", dt1$exc.rate))
head(dt1)
```

```{r}
dim(dt) # 156 9
```
# EDA
```{r}
summary(dt1)
```
Data yang kita miliki terdiri dari 5 peubah yang terdiri dari ekspor, impor, exc.rate, ihsg, dan emas. Data merupakan data bulanan dari Januari 2012 hingga Desember 2024.  Tidak ada data duplikat dan data hilang dalam penelitian ini.

## Plot
```{r}
ggplot(dt1)+
  geom_line(aes(x=periode,y=ekspor),color="blue")+
  geom_line(aes(x=periode,y=impor),color="red")+
  geom_line(aes(x=periode,y=exc.rate),color="green")+
  geom_line(aes(x=periode,y=emas),color="purple")+
  geom_line(aes(x=periode,y=inflasi),color="orange")+
  labs(title = "Time Series Plot", x = "Time", y = "Value") +
  theme_minimal()+
  # add legend
  scale_color_manual(values = c("blue", "red", "green", "purple", "orange"),
                     labels = c("Ekspor", "Impor", "Exc. Rate", "IHSG", "Inflasi")) +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 10)) +
  theme(legend.background = element_rect(fill = "white", color = "black"))
```
Terdapat 5 peubah yang akan kita analisis yaitu ekspor, impor, exc.rate, ihsg, dan emas. Dari plot diatas kita dapat melihat bahwa terdapat pola tren pada data. Satuan dari setiap peubah juga berbeda, maka dari itu kita akan masuk ke process scaling.

Pola trend sudah terlihat.

```{r}
dt1 %>% filter(periode < "2023-01-01") %>% 
  pivot_longer(cols = c(ekspor, impor, exc.rate, emas, inflasi),
               names_to = "variabel",
               values_to = "nilai") %>%
  mutate(variabel = factor(variabel, levels = c("ekspor", "impor", "exc.rate", "emas", "inflasi"))) %>%
  ggplot(aes(x = periode, y = nilai, color = variabel)) +
  geom_line() +
  scale_color_manual(
    values = c(
      "ekspor" = "blue",
      "impor" = "red",
      "exc.rate" = "green",
      "inflasi" = "orange",
      "emas" = "purple"
    ),
    labels = c(
      "Y1 (Nilai Ekspor)",  # ekspor
      "Y2 (Nilai Impor)",  # impor
      "Y3 (Kurs Rupiah)",  # exc.rate
      "Y4 (Inflasi)",   # inflasi
      "Y5 (Harga Emas Berjangka)"  # emas
    )
  ) +
  labs(
    x = "Waktu",
    y = "Nilai"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    legend.background = element_rect(fill = "white", color = "black")
  )
```

```{r}
dt1 %>% 
  pivot_longer(cols = c(ekspor, impor, exc.rate, emas, inflasi),
               names_to = "variabel",
               values_to = "nilai") %>%
  mutate(variabel = factor(variabel, levels = c("ekspor", "impor", "exc.rate", "emas", "inflasi"))) %>%
  ggplot(aes(x = periode, y = nilai, color = variabel)) +
  geom_line() +
  scale_color_manual(
    values = c(
      "ekspor" = "blue",
      "impor" = "red",
      "exc.rate" = "green",
      "inflasi" = "orange",
      "emas" = "purple"
    ),
    labels = c(
      "Y1 (Nilai Ekspor)",  # ekspor
      "Y2 (Nilai Impor)",  # impor
      "Y3 (Kurs Rupiah)",  # exc.rate
      "Y4 (Inflasi)",   # inflasi
      "Y5 (Harga Emas Berjangka)"  # emas
    )
  ) +
  labs(
    x = "Waktu",
    y = "Nilai"
  ) +
  # vertical line at periode 133
  geom_vline(xintercept = as.Date("2023-01-01"), linetype = "dashed", color = "black") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    legend.background = element_rect(fill = "white", color = "black")
  )
```


# Train-Test Split
```{r}
dt1 <- dt1  %>% filter(periode >= "2015-01-01")

# training
dt.tr <- dt1 %>% filter(periode < "2023-01-01")
dt.tt <- dt1 %>% filter(periode >= "2023-01-01")

cat("data training :", nrow(dt.tr), "\n",
    "data testing :", nrow(dt.tt), "\n")
```
## Scaling
```{r}
scale_info <- apply(dt.tr[, -1], 2, function(x) {
  list(mean = mean(x), sd = sd(x))
})

cek1 <- dt.tr
# Scaling
dt.tr <- dt.tr %>%
  mutate_if(is.numeric, function(x) (x - mean(x)) / sd(x))
```


## See Training Data
```{r}
ggplot(dt.tr)+
  geom_line(aes(x=periode,y=ekspor),color="blue")+
  geom_line(aes(x=periode,y=impor),color="red")+
  geom_line(aes(x=periode,y=exc.rate),color="green")+
  geom_line(aes(x=periode,y=emas),color="purple")+
  geom_line(aes(x=periode,y=inflasi),color="orange")+
  labs(title = "Time Series Plot", x = "Time", y = "Value") +
  theme_minimal()
```
```{r}
dt.tr %>%
  pivot_longer(cols = c(ekspor, impor, exc.rate, emas, inflasi),
               names_to = "variabel",
               values_to = "nilai") %>%
  mutate(variabel = factor(variabel, levels = c("ekspor", "impor", "exc.rate", "emas", "inflasi"))) %>%
  ggplot(aes(x = periode, y = nilai, color = variabel)) +
  geom_line() +
  scale_color_manual(
    values = c(
      "ekspor" = "blue",
      "impor" = "red",
      "exc.rate" = "green",
      "inflasi" = "orange",
      "emas" = "purple"
    ),
    labels = c(
      "Y1 (Nilai Ekspor)",  # ekspor
      "Y2 (Nilai Impor)",  # impor
      "Y3 (Kurs Rupiah)",  # exc.rate
      "Y4 (Inflasi)",   # inflasi
      "Y5 (Harga Emas Berjangka)" # emas
    )
  ) +
  labs(
    x = "Waktu",
    y = "Nilai"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    legend.background = element_rect(fill = "white", color = "black")
  )
```

# Stationarity 
## Rataan Level 0
```{r,warning=F}
data.frame(col = names(dt.tr)[-1],
              pval = c(
adf.test(dt.tr$ekspor)$p.value,
adf.test(dt.tr$impor)$p.value,
adf.test(dt.tr$exc.rate)$p.value,
adf.test(dt.tr$emas)$p.value,
adf.test(dt.tr$inflasi)$p.value
))

data.frame(col = names(dt.tr)[-1],
              pval = c(
PP.test(dt.tr$ekspor)$p.value,
PP.test(dt.tr$impor)$p.value,
PP.test(dt.tr$exc.rate)$p.value,
PP.test(dt.tr$emas)$p.value,
PP.test(dt.tr$inflasi)$p.value
))
```
## Rataan Level 1
```{r,warning=F}
data.frame(col = names(dt.tr)[-1],
              pval = c(
adf.test(diff(dt.tr$ekspor))$p.value,
adf.test(diff(dt.tr$impor))$p.value,
adf.test(diff(dt.tr$exc.rate))$p.value,
adf.test(diff(dt.tr$emas))$p.value,
adf.test(diff(dt.tr$inflasi))$p.value
))

data.frame(col = names(dt.tr)[-1],
              pval = c(
PP.test(diff(dt.tr$ekspor))$p.value,
PP.test(diff(dt.tr$impor))$p.value,
PP.test(diff(dt.tr$exc.rate))$p.value,
PP.test(diff(dt.tr$emas))$p.value,
PP.test(diff(dt.tr$inflasi))$p.value
))
```
Hasil dari differencing sudha menunjukan data yang cenderung stasioner dalam rataan. Hal ini menunjukan data yang kita miliki stasioner pada level 1. (Differencing Sekali)

## Ragam
```{r}
ekspor1 <- diff(dt.tr$ekspor)
impor1 <- diff(dt.tr$impor)
exc1 <- diff(dt.tr$exc.rate)
inflasi1 <- diff(dt.tr$inflasi)
emas1 <- diff((dt.tr$emas))

MASS::boxcox(ekspor1 - min(ekspor1) + 1 ~ 1)
MASS::boxcox(impor1 - min(impor1) + 1 ~ 1)
MASS::boxcox(exc1 - min(exc1) + 1 ~ 1)
MASS::boxcox(inflasi1 - min(inflasi1) + 1 ~ 1)
MASS::boxcox(emas1 - min(emas1) + 1 ~ 1,lambda = seq(-2,4,0.1))
```
# Make Data
```{r}
dt.var <- data.frame(
  ekspor = diff(dt.tr$ekspor),
  impor = diff(dt.tr$impor),
  exc.rate = diff(dt.tr$exc.rate),
  inflasi = diff(dt.tr$inflasi),
  emas = diff(dt.tr$emas)
)
```


# Cointegration
```{r}
# Johansen Test
dua <- ca.jo(dt.var, type = "eigen", ecdet = "none", K = 2,spec="longrun")
summary(dua)
```
```{r}
tiga <- ca.jo(dt.var, type = "eigen", ecdet = "none", K = 3,spec="longrun")
summary(tiga)
```
```{r}
# Johansen Test
empat <- ca.jo(dt.var, type = "eigen", ecdet = "none", K = 4,spec="longrun")
summary(empat)
```
```{r}
lima <- ca.jo(dt.var, type = "eigen", ecdet = "const", K = 5,spec="longrun")
summary(lima)
```
```{r}
enam <- ca.jo(dt.var, type = "eigen", ecdet = "const",spec="longrun", K = 6)
summary(enam)
```
```{r}
tujuh <- ca.jo(dt.var, type = "eigen", ecdet = "const",spec="longrun", K = 7)
summary(tujuh)
```


# Trying Prior
```{r}
set.seed(123)

mn <- bv_minnesota(
  lambda = bv_lambda(mode = 1, sd=1),
  #alpha = bv_alpha(mode=2),
  var = 1e3)
```

```{r}
# if statisioner tidak perlu pake ini
soc <- bv_soc(mode = 1, sd = 0.05, min = 1e-04, max = 10)
sur <- bv_sur(mode = 1, sd = 0.05, min = 1e-04, max = 10)
```

```{r}
priors <- bv_priors(hyper = "auto", mn = mn)#,soc=soc,sur=sur)
```

```{r}
mh <- bv_metropolis(scale_hess = c(0.05),#,0.001,0.001),
adjust_acc = TRUE, acc_lower = 0.2, acc_upper = 0.45)
```

```{r}
set.seed(123)

run1 <- bvar(dt.var, lags = 1, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

run2 <- bvar(dt.var, lags = 2, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

run3 <- bvar(dt.var, lags = 3, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

run4 <- bvar(dt.var, lags = 4, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

run5 <- bvar(dt.var, lags = 5, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

run6 <- bvar(dt.var, lags = 6, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

run7 <- bvar(dt.var, lags = 7, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)

```

```{r}
# print aic for each
aic_values <- c(AIC(run2), AIC(run3), AIC(run4), AIC(run5), AIC(run6),AIC(run7))
aic_values

AIC(run1)
```
```{r}
set.seed(123)
run <- bvar(dt.var, lags = 6, n_draw = 20000, n_burn = 5000, n_thin = 1,
priors = priors, mh = mh, verbose = F)
```

```{r}
plot(run)
```
```{r}
AIC(run)
```


```{r}
reverse_scale <- function(scaled_data, variable_name, scale_info) {
  scaled_data * scale_info[[variable_name]]$sd + scale_info[[variable_name]]$mean
}
```


```{r}
fitval <- fitted(run) %>% as.data.frame()
dim(fitval)

y_anchors <- dt.tr[6:94,-1]
fitted_levels <- y_anchors + fitval
fitted_levels <- data.frame(fitted_levels)

fitted_levels_tf <- fitted_levels %>%
  mutate(ekspor = reverse_scale(ekspor, "ekspor", scale_info),
         impor = reverse_scale(impor, "impor", scale_info),
         exc.rate = reverse_scale(exc.rate, "exc.rate", scale_info),
         inflasi = reverse_scale(inflasi, "inflasi", scale_info),
         emas = reverse_scale(emas, "emas", scale_info))

true_levels <- cek1[7:95,-1]

mape <- colMeans(abs((true_levels - fitted_levels_tf)/true_levels)) * 100
print(round(mape,4))
```
```{r}
ggplot(fitted_levels_tf)+
  geom_line(aes(x=1:89,y=ekspor),color="blue")+
  geom_line(aes(x=1:89,y=impor),color="red")+
  geom_line(aes(x=1:89,y=exc.rate),color="green")+
  geom_line(aes(x=1:89,y=emas),color="purple")+
  geom_line(aes(x=1:89,y=inflasi),color="orange")
```


## Prediction
```{r}
pred <- predict(run, horizon = 24)

hasil_pred <- matrix(NA,nrow=24,ncol=5)

for(i in 1:5){
  for(j in 1:24){
    hasil_pred[j,i] <- pred$fcast[,j,i] %>% mean()
  }
}

hasil_pred <- data.frame(hasil_pred)
names(hasil_pred) <- c("ekspor","impor","exc.rate","emas","inflasi")

test_anchor <- rbind(dt.var[95,],hasil_pred[1:23,])
hasil_pred <- hasil_pred[1:24,] + test_anchor


hasil_pred_tf <- hasil_pred %>%
  mutate(ekspor = reverse_scale(ekspor, "ekspor", scale_info),
         impor = reverse_scale(impor, "impor", scale_info),
         exc.rate = reverse_scale(exc.rate, "exc.rate", scale_info),
         emas = reverse_scale(emas, "emas", scale_info),
         inflasi = reverse_scale(inflasi, "inflasi", scale_info))

true_test <- dt.tt[,-1]


mape_test <- colMeans(abs((true_test - hasil_pred_tf)/true_test)) * 100
print(round(mape_test,4))
```
# Plot Prediction
```{r}
ggplot(hasil_pred)+
  geom_line(aes(x=1:24,y=ekspor),color="blue")+
  geom_line(aes(x=1:24,y=impor),color="red")+
  geom_line(aes(x=1:24,y=exc.rate),color="green")+
  geom_line(aes(x=1:24,y=emas),color="purple")+
  geom_line(aes(x=1:24,y=inflasi),color="orange")+
  labs(title = "Time Series Plot", x = "Time", y = "Value") +
  theme_minimal()
```
```{r}
plot(pred)
```


# IRF
```{r}
irf_res <- BVAR::irf(run)
names(irf_res)

plot(irf_res)
```

# Diagnostic Checking
```{r}
resid <- residuals(run) %>% as.data.frame()
```

```{r}
library(ggplot2)
ggplot(resid) +
  geom_line(aes(x=1:nrow(resid),y=ekspor),color="blue")+
  geom_line(aes(x=1:nrow(resid),y=impor),color="red")+
  geom_line(aes(x=1:nrow(resid),y=exc.rate),color="green")+
  geom_line(aes(x=1:nrow(resid),y=emas),color="purple")+
  geom_line(aes(x=1:nrow(resid),y=inflasi),color="orange")+
  labs(title = "Time Series Plot", x = "Time", y = "Value") +
  theme_minimal()
```
```{r}
acf(resid$ekspor)
```

```{r}
acf(resid$impor)
```
```{r}
acf(resid$exc.rate)
```
```{r}
acf(resid$inflasi)
```

```{r}
acf(resid$emas)
```

```{r}
Box.test(resid$ekspor,type="Ljung-Box")
Box.test(resid$impor, ,type="Ljung-Box")
Box.test(resid$exc.rate,type="Ljung-Box")
Box.test(resid$inflasi,type="Ljung-Box")
Box.test(resid$emas, type = "Ljung-Box")
```
```{r}
Box.test(resid$ekspor^2,type="Ljung-Box")
Box.test(resid$impor^2,type="Ljung-Box") # langgar
Box.test(resid$exc.rate^2,type="Ljung-Box") # langgar
Box.test(resid$inflasi^2,type="Ljung-Box")
Box.test(resid$emas^2,type="Ljung-Box")
```
# plot posterior

```{r}
plot(run,type="dens",vars_response = "ekspor",vars_impulse="ekspor-lag1")
plot(run,type="trace",vars_response = "ekspor",vars_impulse="ekspor-lag1")
plot(run,type="dens",vars_response = "ekspor",vars_impulse="impor-lag1")
plot(run,type="trace",vars_response = "ekspor",vars_impulse="impor-lag1")
```
# Uji Hipotesis pada Posterior
## Lambda
```{r}
quantile(run$hyper, probs = c(0.025, 0.5, 0.975))
```
Nilai lambda menunjukan bahwa terdapat perubahan pada keperycaan awal kita bahwa setiap peubah akan mengikut proses random walk. 

## Intersep
```{r}
#ekspor
run$beta[,1,1] %>% quantile(probs = c(0.025, 0.5, 0.975))
```
```{r}
# impor
run$beta[,1,2] %>% quantile(probs = c(0.025, 0.5, 0.975))
```

```{r}
# exc.rate
run$beta[,1,3] %>% quantile(probs = c(0.025, 0.5, 0.975))
```
```{r}
# emas
run$beta[,1,4] %>% quantile(probs = c(0.025, 0.5, 0.975))
```
```{r}
# inflasi
run$beta[,1,5] %>% quantile(probs = c(0.025, 0.5, 0.975))
```

## Ekspor lag1
```{r}
plot(run,type="dens",vars_response = "ekspor",vars_impulse="ekspor-lag1")
```
```{r}
run$beta[,2,1] %>% quantile(probs = c(0.025, 0.5, 0.975))
```


```{r}
plot(run,type="dens",vars_response = "ekspor",vars_impulse="impor-lag1")
```
```{r}
run$beta[,3,1] %>% quantile(probs = c(0.025, 0.5, 0.975))
```
```{r}
plot(run,type="dens",vars_response = "ekspor",vars_impulse="exc.rate-lag1")
```

```{r}
run$beta[,4,1] %>% quantile(probs = c(0.025, 0.5, 0.975))
```
# IRF firlan
```{r}
plot(irf(run),area=T,
     vars_impulse = "exc.rate",vars_response="inflasi",
     )
```



```{r}
plot(irf(run),area=T,
     vars_impulse = "inflasi",vars_response="exc.rate"
     )
```


```{r}
plot(irf(run),area=T,
     vars_impulse = "emas",vars_response="inflasi"
     )
```

```{r}
plot(irf(run),area=T,
     vars_impulse = "ekspor",vars_response="impor"
     )
```


# Extract Posterior
```{r}
run$beta %>% dim()
#15000    31     5

hasil <- matrix(NA,nrow=31,ncol=5)

for(i in 1:31){
  for(j in 1:5){
    hasil[i,j] <- run$beta[,i,j] %>% mean()
  }
}

hasil %>% t() %>%  as.data.frame() %>% View()
```

```{r}
plot(run,type="dens",vars_response = "ekspor", vars_impulse="ekspor-lag1")
abline(v=run$beta[,2,1] %>% mean(),col="red",lty=2)
```

```{r}
plot(run,type="dens",vars_response = "ekspor", vars_impulse="inflasi-lag1")
abline(v=run$beta[,5,1] %>% mean(),col="red",lty=2)
```




```{r}
run$sigma %>% dim()
```

```{r}
run$beta %>% dim()
```
```{r}
phi_list <- list()

mean_beta <- apply(run$beta,c(2,3),mean) %>% as.matrix()

for(i in 1:6){
  rows = 2 + (i-1) * 5
  phi_list[[i]] <- mean_beta[rows:rows+4,]
}
```

```{r}
phi_list
```
```{r}
coef(run, conf_bands = 0.05)
```
```{r}
hasil_model <- coef(run, conf_bands = 0.025) %>% as.array()
dim(hasil_model)
```
```{r}
hasil_model
```
```{r}
# saveRDS(hasil_model10, "D:\\IPB\\6\\Bayes\\Projek\\hasil_model10.rds")
# 
hasil_model10 <- coef(run, conf_bands = 0.05) %>% as.array()
```

```{r}
ht5persen <- !((hasil_model[1,,] <=0) & (hasil_model[3,,] >=0))
ht5persen
```
```{r}
ht10persen <- !((hasil_model10[1,,] <=0) & (hasil_model[3,,] >=0))
ht10persen
```
# FEVD
```{r}
fevd(run)
summary(run)
```
```{r}
fevd_res <- fevd(run)
fevd_res_med <- fevd_res$quants[2,,,]

fevd_res_med %>% dim()

var_index <- 1    # variable whose FEVD you want to plot
horizon <- 6      # forecast horizon to visualize

fevd_samples <- fevd_res_med[var_index,horizon,]

barplot(fevd_samples, names.arg = paste0("Shock ", 1:5),
        main = paste("FEVD for Variable", var_index, "at Horizon", horizon),
        ylab = "Median FEVD",
        col = "steelblue")

```
```{r}
fevd_list <- list()

for(i in 1:5){
  fevd_list[[i]] <- fevd_res_med[i,,]
}

```

```{r}
library(tidyr)
```

```{r}
plot_fevd <- function(fevd_list, i) {
  # Extract the FEVD matrix from list element i and convert to dataframe
  fevd_res <- fevd_list[[i]] %>% as.data.frame()
  
  # Rename columns (adjust names as needed)
  colnames(fevd_res) <- c("ekspor", "impor", "exc.rate", "inflasi", "emas")
  
  # Add horizon column (assuming 12 horizons)
  fevd_res$horizon <- 1:nrow(fevd_res)
  
  # Convert to long format for ggplot
  fevd_long <- pivot_longer(fevd_res, cols = c("ekspor", "impor", "exc.rate", "inflasi", "emas"),
                           names_to = "Shock", values_to = "FEVD")
  
  # Plot stacked bar chart
  ggplot(fevd_long, aes(x = factor(horizon), y = FEVD, fill = Shock)) +
    geom_bar(stat = "identity") +
    labs(title = paste("Stacked FEVD for Forecast Horizons (Index", i, ")"),
         x = "Forecast Horizon",
         y = "FEVD (Proportion of Variance Explained)") +
    theme_minimal() +
    scale_fill_brewer(palette = "Set2")
}
```

```{r}
plot_fevd <- function(fevd_list, i, show_legend = TRUE) {
  # Extract the FEVD matrix from list element i and convert to dataframe
  fevd_res <- fevd_list[[i]] %>% as.data.frame()
  
  # Rename columns
  colnames(fevd_res) <- c("ekspor", "impor", "exc.rate", "inflasi", "emas")
  
  # Add horizon column
  fevd_res$horizon <- 1:nrow(fevd_res)
  
  # Convert to long format
  fevd_long <- pivot_longer(
    fevd_res, 
    cols = c("ekspor", "impor", "exc.rate", "inflasi", "emas"),
    names_to = "Shock", 
    values_to = "FEVD"
  )
  
  # Set factor level order for Shock
  fevd_long$Shock <- factor(fevd_long$Shock, levels = c("ekspor", "impor", "exc.rate", "inflasi", "emas"))

  # Define custom colors
  custom_colors <- c(
    "ekspor" = "blue",
    "impor" = "red",
    "exc.rate" = "green",
    "inflasi" = "orange",
    "emas" = "purple"
  )
  
  # Define custom labels
  custom_labels <- c(
    "ekspor" = "Y1 (Nilai Ekspor)",
    "impor" = "Y2 (Nilai Impor)",
    "exc.rate" = "Y3 (Kurs Rupiah)",
    "inflasi" = "Y4 (Inflasi)",
    "emas" = "Y5 (Harga Emas Berjangka)"
  )

  # Build the base plot
  p <- ggplot(fevd_long, aes(x = factor(horizon), y = FEVD, fill = Shock)) +
    geom_bar(stat = "identity") +
    labs(
      x = "Forecast Horizon",
      y = "FEVD (Proportion of Variance Explained)"
    ) +
    theme_minimal() +
    scale_fill_manual(
      values = custom_colors,
      labels = custom_labels,
      name = "Shock"
    )
  
  # Optionally remove legend
  if (!show_legend) {
    p <- p + theme(legend.position = "none")
  }
  
  return(p)
}
```


```{r}
plot_fevd(fevd_list,1,F)
```


```{r}
plot_fevd(fevd_list,2,F)
```
```{r}
plot_fevd(fevd_list,3,F)
```

```{r}
plot_fevd(fevd_list,4,F)
```


```{r}
plot_fevd(fevd_list,5)
```








